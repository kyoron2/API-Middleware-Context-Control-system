# å¿«é€Ÿå¼€å§‹æŒ‡å—

5 åˆ†é’Ÿå†…å¯åŠ¨å¹¶è¿è¡Œ API ä¸­é—´å±‚ä¸Šä¸‹æ–‡æ§åˆ¶ç³»ç»Ÿã€‚

## å‰ç½®è¦æ±‚

- å·²å®‰è£… Python 3.11+
- Docker å’Œ Docker Composeï¼ˆå¯é€‰ï¼Œç”¨äºå®¹å™¨åŒ–éƒ¨ç½²ï¼‰
- è‡³å°‘ä¸€ä¸ª LLM API å¯†é’¥ï¼ˆä¾‹å¦‚ OpenAIï¼‰

## æ–¹å¼ä¸€ï¼šæœ¬åœ°å¼€å‘éƒ¨ç½²

### æ­¥éª¤ 1ï¼šå®‰è£…ä¾èµ–

```bash
# æ¿€æ´»ä½ çš„ Python ç¯å¢ƒ
# å¯¹äº conda ç”¨æˆ·ï¼š
activate django

# ä½¿ç”¨ uv å®‰è£…ä¾èµ–
uv add fastapi pydantic httpx pyyaml python-dotenv uvicorn redis
uv add --dev pytest pytest-asyncio
```

### æ­¥éª¤ 2ï¼šé…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¤ºä¾‹ç¯å¢ƒæ–‡ä»¶
cp .env.example .env

# ç¼–è¾‘ .env å¹¶æ·»åŠ ä½ çš„ API å¯†é’¥
# ç¤ºä¾‹ï¼š
# OPENAI_API_KEY=sk-your-key-here
```

### æ­¥éª¤ 3ï¼šé…ç½®æä¾›å•†

ç¼–è¾‘ `config/config.yaml` æ·»åŠ ä½ çš„ API æä¾›å•†ï¼š

```yaml
providers:
  - name: official
    base_url: https://api.openai.com/v1
    api_key: ${OPENAI_API_KEY}
    timeout: 30
    models:
      - gpt-4
      - gpt-3.5-turbo

model_mappings:
  - display_name: official/gpt-4
    provider_name: official
    actual_model_name: gpt-4
```

### æ­¥éª¤ 4ï¼šæµ‹è¯•é…ç½®

```bash
# è¿è¡Œæ‰‹åŠ¨æµ‹è¯•è„šæœ¬
python test_manual.py

# ä½ åº”è¯¥çœ‹åˆ°ï¼š
# âœ“ All manual tests passed!
```

### æ­¥éª¤ 5ï¼šå¯åŠ¨æœåŠ¡å™¨

```bash
# å¯åŠ¨ä¸­é—´å±‚æœåŠ¡å™¨
python -m src.main

# æœåŠ¡å™¨å°†åœ¨ http://localhost:8000 å¯åŠ¨
```

### æ­¥éª¤ 6ï¼šéªŒè¯è¿è¡Œ

```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
curl http://localhost:8000/health

# åˆ—å‡ºå¯ç”¨æ¨¡å‹
curl http://localhost:8000/v1/models

# æµ‹è¯•èŠå¤©å®Œæˆï¼ˆéœ€è¦åœ¨é…ç½®ä¸­æ›¿æ¢ä¸ºå®é™…çš„ API å¯†é’¥ï¼‰
curl -X POST http://localhost:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "official/gpt-4",
    "messages": [
      {"role": "user", "content": "ä½ å¥½ï¼"}
    ]
  }'
```

## æ–¹å¼äºŒï¼šDocker éƒ¨ç½²

### æ­¥éª¤ 1ï¼šé…ç½®ç¯å¢ƒ

```bash
# å¤åˆ¶ç¤ºä¾‹ç¯å¢ƒæ–‡ä»¶
cp .env.example .env

# ç¼–è¾‘ .env å¹¶æ·»åŠ ä½ çš„ API å¯†é’¥
```

### æ­¥éª¤ 2ï¼šé…ç½®æä¾›å•†

æŒ‰ç…§æ–¹å¼ä¸€ä¸­çš„è¯´æ˜ç¼–è¾‘ `config/config.yaml`ã€‚

### æ­¥éª¤ 3ï¼šä½¿ç”¨ Docker Compose å¯åŠ¨

```bash
# æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f middleware

# æœåŠ¡å™¨å°†åœ¨ http://localhost:8000 å¯åŠ¨
```

### æ­¥éª¤ 4ï¼šéªŒè¯è¿è¡Œ

```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
curl http://localhost:8000/health

# åˆ—å‡ºå¯ç”¨æ¨¡å‹
curl http://localhost:8000/v1/models
```

## ä¸ OpenWebUI é›†æˆ

### æ­¥éª¤ 1ï¼šæ‰“å¼€ OpenWebUI è®¾ç½®

å¯¼èˆªåˆ°ä½ çš„ OpenWebUI å®ä¾‹ï¼ˆé€šå¸¸æ˜¯ http://localhost:3000 æˆ–ä½ çš„éƒ¨ç½² URLï¼‰ã€‚

### æ­¥éª¤ 2ï¼šæ·»åŠ  API è¿æ¥

1. è¿›å…¥ è®¾ç½® â†’ è¿æ¥ï¼ˆæˆ–ç±»ä¼¼èœå•ï¼‰
2. ç‚¹å‡»"æ·»åŠ è¿æ¥"æˆ–"æ·»åŠ  API"
3. å¡«å†™è¯¦ç»†ä¿¡æ¯ï¼š
   - **åç§°**ï¼šAPI ä¸­é—´å±‚
   - **API Base URL**ï¼š`http://localhost:8000/v1`
   - **API Key**ï¼š`dummy`ï¼ˆä¸­é—´å±‚ä¸ä½¿ç”¨æ­¤å¯†é’¥ï¼‰
4. ä¿å­˜è¿æ¥

### æ­¥éª¤ 3ï¼šé€‰æ‹©æ¨¡å‹

åœ¨ OpenWebUI çš„æ¨¡å‹é€‰æ‹©å™¨ä¸­ï¼Œä½ ç°åœ¨åº”è¯¥èƒ½çœ‹åˆ°æ¥è‡ªä¸­é—´å±‚çš„æ¨¡å‹ï¼š
- `official/gpt-4`
- `official/gpt-3.5-turbo`
- ï¼ˆä»¥åŠä½ é…ç½®çš„å…¶ä»–æ¨¡å‹ï¼‰

### æ­¥éª¤ 4ï¼šå¼€å§‹å¯¹è¯

é€‰æ‹©ä¸€ä¸ªæ¨¡å‹å¹¶å¼€å§‹èŠå¤©ï¼ä¸­é—´å±‚å°†è‡ªåŠ¨ï¼š
- ç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡
- åœ¨è¾¾åˆ°é™åˆ¶æ—¶å‡å°‘ Token ä½¿ç”¨
- å°†è¯·æ±‚è·¯ç”±åˆ°é€‚å½“çš„æä¾›å•†

## é…ç½®æŠ€å·§

### ä¸Šä¸‹æ–‡ç®¡ç†

æ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©ç¼©å‡ç­–ç•¥ï¼š

**æˆªæ–­ç­–ç•¥**ï¼ˆæœ€ç®€å•ï¼‰ï¼š
```yaml
context_config:
  max_turns: 10
  reduction_mode: truncation
```

**æ»‘åŠ¨çª—å£ç­–ç•¥**ï¼ˆåŸºäº Tokenï¼‰ï¼š
```yaml
context_config:
  max_tokens: 4000
  reduction_mode: sliding_window
```

**æ‘˜è¦ç­–ç•¥**ï¼ˆæœ€æ™ºèƒ½ï¼‰ï¼š
```yaml
context_config:
  max_turns: 10
  reduction_mode: summarization
  summarization_model: gpt-3.5-turbo
```

### å¤šä¸ªæä¾›å•†

æ·»åŠ å¤šä¸ª API æä¾›å•†ä»¥å®ç°å†—ä½™æˆ–æˆæœ¬ä¼˜åŒ–ï¼š

```yaml
providers:
  - name: official
    base_url: https://api.openai.com/v1
    api_key: ${OPENAI_API_KEY}
    models:
      - gpt-4
  
  - name: proxy1
    base_url: https://proxy.example.com/v1
    api_key: ${PROXY1_API_KEY}
    models:
      - claude-3-opus
      - claude-3-sonnet

model_mappings:
  - display_name: official/gpt-4
    provider_name: official
    actual_model_name: gpt-4
  
  - display_name: proxy1/claude-opus
    provider_name: proxy1
    actual_model_name: claude-3-opus
```

### ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Redis

å¯¹äºç”Ÿäº§éƒ¨ç½²ï¼Œä½¿ç”¨ Redis è¿›è¡Œä¼šè¯å­˜å‚¨ï¼š

```yaml
storage:
  type: redis
  redis_url: redis://localhost:6379
  redis_db: 0
```

ç„¶åå¯åŠ¨ Redisï¼š
```bash
# ä½¿ç”¨ Docker Composeï¼ˆå·²åŒ…å«ï¼‰
docker-compose up -d

# æˆ–ç‹¬ç«‹è¿è¡Œ
docker run -d -p 6379:6379 redis:alpine
```

## ç›‘æ§

### æŸ¥çœ‹æ—¥å¿—

æ—¥å¿—ä»¥ JSON æ ¼å¼è¾“å‡ºï¼Œä¾¿äºè§£æï¼š

```bash
# æœ¬åœ°å¼€å‘
python -m src.main | jq .

# Docker
docker-compose logs -f middleware | jq .
```

### éœ€è¦ç›‘æ§çš„å…³é”®æŒ‡æ ‡

- **Token ä½¿ç”¨é‡**ï¼šæŸ¥æ‰¾ `event_type: "api_completion"` åŠå…¶ `tokens` å­—æ®µ
- **ä¸Šä¸‹æ–‡ç¼©å‡**ï¼šæŸ¥æ‰¾ `event_type: "context_reduction"`
- **é”™è¯¯**ï¼šæŸ¥æ‰¾ `level: "ERROR"` æˆ– `event_type: "provider_error"`

## æ•…éšœæ’é™¤

### é—®é¢˜ï¼š"é…ç½®åŠ è½½å¤±è´¥"

**è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥ `config/config.yaml` æ˜¯å¦å­˜åœ¨ä¸”ä¸ºæœ‰æ•ˆçš„ YAMLã€‚

```bash
# éªŒè¯ YAML è¯­æ³•
python -c "import yaml; yaml.safe_load(open('config/config.yaml'))"
```

### é—®é¢˜ï¼š"æä¾›å•†è¿”å›é”™è¯¯ï¼šæœªæˆæƒ"

**è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ API å¯†é’¥ã€‚

```bash
# éªŒè¯ç¯å¢ƒå˜é‡å·²è®¾ç½®
echo $OPENAI_API_KEY  # Linux/Mac
echo %OPENAI_API_KEY%  # Windows CMD
```

### é—®é¢˜ï¼š"æ‰¾ä¸åˆ°æ¨¡å‹"

**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿æ¨¡å‹åŒæ—¶åˆ—åœ¨ `providers.models` å’Œ `model_mappings` ä¸­ã€‚

```bash
# åˆ—å‡ºå¯ç”¨æ¨¡å‹
curl http://localhost:8000/v1/models
```

### é—®é¢˜ï¼š"è¿æ¥è¢«æ‹’ç»"

**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œã€‚

```bash
# æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
curl http://localhost:8000/health

# æ£€æŸ¥ Docker å®¹å™¨
docker-compose ps
```

## ä¸‹ä¸€æ­¥

- é˜…è¯»å®Œæ•´çš„ [README.md](README.md) è·å–è¯¦ç»†æ–‡æ¡£
- æŸ¥çœ‹ [docs/API.md](docs/API.md) è·å–å®Œæ•´çš„ API å‚è€ƒ
- æŸ¥çœ‹ [é…ç½®è¯¦è§£.md](é…ç½®è¯¦è§£.md) äº†è§£æ‰€æœ‰é…ç½®é€‰é¡¹
- æ¢ç´¢ `config/config.yaml` ä¸­çš„é…ç½®é€‰é¡¹
- ç›‘æ§æ—¥å¿—ä»¥ä¼˜åŒ– Token ä½¿ç”¨

## è·å–å¸®åŠ©

- æŸ¥çœ‹ [README.md](README.md) è·å–è¯¦ç»†æ–‡æ¡£
- æŸ¥çœ‹ [docs/API.md](docs/API.md) è·å– API è¯¦æƒ…
- æŸ¥çœ‹ [é…ç½®è¯¦è§£.md](é…ç½®è¯¦è§£.md) è·å–é…ç½®è¯´æ˜
- æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯æ¶ˆæ¯
- ä½¿ç”¨ `python test_manual.py` éªŒè¯é…ç½®

## æˆåŠŸï¼

ä½ ç°åœ¨æ‹¥æœ‰ä¸€ä¸ªå¯å·¥ä½œçš„ API ä¸­é—´å±‚ï¼Œå®ƒèƒ½å¤Ÿï¼š
- âœ… è‡ªåŠ¨ç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡
- âœ… é€šè¿‡æ™ºèƒ½ç­–ç•¥é™ä½ Token æˆæœ¬
- âœ… å°†è¯·æ±‚è·¯ç”±åˆ°å¤šä¸ªæä¾›å•†
- âœ… ä¸ OpenWebUI æ— ç¼é›†æˆ

å¼€å§‹æ„‰å¿«çš„å¯¹è¯å§ï¼ğŸš€
