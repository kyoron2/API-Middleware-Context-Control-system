
## 📄《多模型 API 中间层与上下文控制系统》需求说明文档（概念版）

### 一、项目背景

当前用户在 Ubuntu 虚拟机中，通过 Docker 部署了 **OpenWebUI** 作为大模型交互界面。
在日常使用过程中，用户需要频繁调用多个不同来源的 **API 模型服务**，包括官方 API 站点与多个代理站点（New API Proxy 等）。
这些 API 服务具有不同的计费方式与请求成本，在持续对话场景下，**上下文过长会显著增加 Token 消耗与费用**。

OpenWebUI 目前提供了基础的「记忆区」与自定义函数功能，但其缺少以下能力：

* ❌ 无法对对话历史进行自动压缩或裁剪
* ❌ 无法为每个 API 站点配置独立的上下文策略
* ❌ 无法统一管理多个模型与站点的映射关系
* ❌ 无法作为“总入口”对 API 请求进行优化与调度

因此，需要一个位于 WebUI 与各模型 API 之间的**中间控制层**，对请求流转进行统一管理。

---

### 二、现有环境与使用模式

1. **部署环境**

   * Ubuntu 虚拟机
   * 通过 Docker 运行 OpenWebUI
   * 可接受增加新容器

2. **应用使用方式**

   * OpenWebUI 作为主要操作入口
   * 用户通过 UI 手动选择模型与 API Endpoint
   * 多个 API 服务来源并存
   * 存在长对话使用场景
    使用python 实现

3. **现存问题**

   * OpenWebUI 当前 **默认全量携带上下文**
   * 无历史压缩机制 → Token 成本持续增长
   * 记忆区 ≈ 语义归纳，**不能替代上下文缩减**
   * 自定义函数分散，缺少统一控制能力
   * 多 API 来源管理复杂，不利于扩展与维护

---

### 三、问题动机

用户的核心诉求不是单一的“省 Token”，而是：

* 🌟 在不改变现有 OpenWebUI 使用体验的前提下
* 🌟 引入一个“可控”“可配置”的对话管理与路由系统
* 🌟 对多站点、多模型、多场景进行统一治理

换句话说：

> 需要把“人工管理上下文 + 手动切换 API 模型”的工作
> 变成“自动化、策略化、可伸缩”的系统能力。

---

### 四、目标与愿景

该系统应当具备以下整体目标：

#### 1️⃣ 作为 “统一 API 入口”

* 对 OpenWebUI 来说，它表现为 **一个新的 API 站点**
* OpenWebUI 不需要感知内部细节
* 继续使用现有模型选择 UI

#### 2️⃣ 作为 “上下文管理控制器”

* 负责：

  * ⏳ 上下文条数限制
  * ✂️ 自动摘要 / 历史压缩策略
  * 📌 重要内容保留机制
* 用户可通过策略规则进行调整
* 不依赖 WebUI 内部功能

#### 3️⃣ 作为 “模型与站点路由层”

* 统一维护：

  * 多个 API Base URL
  * 多个模型
  * 代理站点
* 允许：

  * 为每个模型配置调用策略
  * 对模型名称增加命名空间前缀（避免冲突）
  * 自动映射与转发

#### 4️⃣ 不强制引入额外小模型

* 系统不依赖内嵌摘要模型
* 可在需要时调用任意站点模型执行摘要
* 保持最大灵活性

---

### 五、使用场景描述

#### 场景一：长对话成本控制

* 用户进行持续提问
* 历史内容变长
* 系统根据策略：

  * 裁剪早期内容
  * 或转化为摘要
  * 或写入记忆区
* 返回给模型的上下文始终受控

#### 场景二：多代理站点统一管理

* 用户拥有多个 API 代理商
* 系统作为路由层：

  * 根据配置选择站点
  * 或根据模型分类自动分流

#### 场景三：OpenWebUI 继续保持“原体验”

* 用户仍然可以：

  * 在 UI 中选择模型
  * 查看历史对话
* 但请求实际经过中间层优化

---

### 六、非目标（系统不关注的内容）

* ❌ 不替代 OpenWebUI
* ❌ 不改变界面交互逻辑
* ❌ 不实现本地模型推理
* ❌ 不承担计费或监控分析职能（后期可扩展）

---

### 七、成功标准

✔ Token 成本明显下降
✔ 对话不会无限膨胀
✔ 多 API 管理更简洁
✔ 用户无需改变操作习惯
✔ 部署方式简单，可容器化

---

### 八、后续阶段规划（仅方向性）

> *以下内容仅用于说明发展空间，不涉及技术方案*

* 阶段 1：基础上下文控制 + 转发
* 阶段 2：策略化可配置系统
* 阶段 3：支持多用户 / 多会话隔离
* 阶段 4：引入监控与统计

---

## ✅ 结尾说明

这份文档主要作用是：

* 帮助明确需要解决的 **真实问题**
* 把“功能点”提升为“系统能力级需求”
* 为后续技术方案与设计讨论奠定统一语义基础

---
好的，下面是在上一份“概念性需求说明”的基础上，进一步细化为**偏功能列表的功能需求文档**。
本版本仍然保持“产品与功能视角”，不涉及实现技术与代码。

---

## 📄《多模型 API 中间层与上下文控制系统》

### ——功能需求细化文档（V1）

---

## 一、系统角色与视角

系统涉及三类核心角色/对象：

1. **用户（通过 OpenWebUI 使用模型的操作者）**
2. **OpenWebUI（前端对话入口）**
3. **API 中间层（本系统）**

> OpenWebUI 仅视本系统为一个新的 API Endpoint
> 本系统负责后端逻辑、路由与上下文管理

---

## 二、核心功能模块总览

本系统核心功能由六大模块组成：

1. **会话与上下文管理模块**
2. **上下文缩减与摘要策略模块**
3. **多 API 站点与模型路由模块**
4. **模型映射与命名空间管理模块**
5. **配置与策略管理模块**
6. **监控与可观测性（基础版，可选）**

下面逐项展开。

---

## 三、功能模块细化说明

---

### 1️⃣ 会话与上下文管理模块

**功能目标**
对来自 OpenWebUI 的每个会话进行独立管理与生命周期控制。

**功能点**

* 会话唯一标识支持：

  * 会话 ID
  * 用户 ID（如未来支持多用户）
* 为每个会话维护：

  * 历史对话记录（受策略控制）
  * 上下文摘要区（总结性保留内容）
  * 永久记忆区（类似长期信息）
* 支持以下上下文配置项：

  * 最大轮次限制（如 N 条）
  * 最大 Token 限额（软阈值）
  * 自动触发压缩条件
* 支持会话重置：

  * 清空历史
  * 仅保留长期记忆

**非目标**

* 不负责 UI 展示
* 不依赖 OpenWebUI 的会话机制

---

### 2️⃣ 上下文缩减与摘要策略模块

**功能目标**
在不影响对话质量的前提下，减少传递给模型的上下文体量。

**功能点**

* 支持多种缩减模式：

  * 历史裁剪（删除最早几轮）
  * 模式化摘要（重要信息提炼）
  * 分段归档（相似内容合并）
* 支持摘要优先级

  * 问题线索优先保留
  * 用户意图优先保留
  * 任务说明长期保留
* 支持策略触发条件：

  * 达到轮次阈值
  * 达到 Token 阈值
  * 主动手动触发（未来可扩展 API）
* 支持摘要来源模型选择：

  * 与主模型同源
  * 或指定摘要模型
* 可选行为：

  * 将裁剪后摘要写入“记忆区”
  * 在后续轮次重复携带

**约束**

* 不要求绝对语义无损
* 目标：性价比优先

---

### 3️⃣ 多 API 站点与模型路由模块

**功能目标**
统一代理多个 API Endpoint 与模型服务。

**功能点**

* 支持配置多个：

  * Base URL（站点）
  * API Key
  * 代理站点类型（不同供应商）
* 支持模型与站点绑定规则：

  * 某模型只允许走某站点
  * 某站点只允许运行特定模型
* 支持路由策略：

  * 固定路由（默认模式）
  * 按模型字段识别
  * 按命名空间自动匹配
* 支持错误回退策略：

  * 某站点不可用 → 可切换
  * 可开启或关闭

**未来扩展方向（非必需）**

* 带权负载调度
* 成本优先 / 性能优先模式

---

### 4️⃣ 模型映射与命名空间管理模块

**功能目标**
为 OpenWebUI 提供统一模型列表，不破坏现有选择体验。

**功能点**

* 允许本系统内部维护：

  * 实际模型名（真实 API 名）
  * 对外展示名（供 WebUI 识别）
* 支持命名空间：

  * 示例：

    * `proxyA/gpt-4`
    * `proxyB/qwen-plus`
* 支持自动映射：

  * WebUI 请求 → 中间层模型名 → 实际 API 模型
* 支持模型集群分组：

  * 同类模型共用摘要策略
  * 同类模型共用上下文策略

**优势**

* 不破坏 WebUI UI
* 兼容无限扩展代理源

---

### 5️⃣ 配置与策略管理模块

**功能目标**
允许对系统行为进行集中化管理与调整。

**功能点**

* 支持配置项类别：

  * 系统级
  * 会话级
  * 模型级
  * 站点级
* 支持配置形式：

  * 静态配置文件
  * 环境变量
    -（未来可扩展 Web 控制台）
* 可配置内容（示例）：

  * 最大上下文轮次
  * 是否启用摘要
  * 指定摘要模型
  * 指定 API 路由规则
  * 最大 Token 预算
* 支持配置热更新（可选）

---

### 6️⃣ 监控与可观测性（基础版）

**功能目标**
帮助用户理解系统运行行为与节省效果。

**基础功能（V1 可选）**

* 记录基础指标：

  * 每次调用 Token 输入/输出统计
  * 上下文裁剪次数
  * 摘要触发次数
* 记录错误日志：

  * 调用失败
  * 站点不可用
* 可导出日志（JSON 或文本）

**未来扩展**

* Web 可视化面板
* 成本趋势分析
* 模型调用排行

---

## 四、功能边界与排除项

本系统**不覆盖以下内容**：

* ❌ 不负责 UI 展示
* ❌ 不更改 OpenWebUI 内部逻辑
* ❌ 不涉及本地部署模型
* ❌ 不提供用户身份体系（V1）
* ❌ 不作为计费系统
* ❌ 不管理第三方 API 账号生命周期

目标定位：
👉 **轻量层级式中间控制系统，而非平台型产品**

---

## 五、最小可用功能（MVP）

第一阶段应至少具备：

1. 基础 API 转发
2. 会话上下文存储
3. 上下文轮次限制
4. 简单摘要/裁剪策略
5. 多站点配置与模型映射
6. 作为 OpenWebUI 新 API Endpoint 使用

> 其他功能可逐步演进

---

## 六、验收标准（功能维度）

✔ WebUI 可正常调用系统作为 API
✔ 对话不会无限增长
✔ Token 占用明显下降
✔ 可灵活切换模型来源
✔ 多站点环境运行稳定
✔ 上下文行为按策略执行

---


